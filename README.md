# Miracle Heart Light App

特定の高周波数の音響信号をリアルタイムに検知し、スマートフォンの画面をカラフルに点灯させる Android アプリケーションです。

サンリオピューロランドのパレード「Miracle Gift Parade」で実際に使用される「ミラクル♡ライト」の動作を、Androidスマートフォン上で再現することを目的としたファンプロジェクトです。

[![Build Status](https://img.shields.io/badge/build-passing-brightgreen)](https://github.com)
[![Platform](https://img.shields.io/badge/platform-Android-green.svg)](https://www.android.com)
[![Kotlin](https://img.shields.io/badge/Kotlin-1.9.0-blue.svg)](https://kotlinlang.org)
[![Jetpack Compose](https://img.shields.io/badge/Jetpack_Compose-1.6-blue.svg)](https://developer.android.com/jetpack/compose)

## 概要 (Overview)

このアプリは、特定の周波数で構成された音響信号をスマートフォンのマイクでリアルタイムにキャプチャし、その信号パターンを解析します。検出された信号に応じて、対応するライトパターン（画面の点滅や色の遷移）を画面全体で実行します。

また、検出した周波数を可聴音としてスピーカーから再生する機能も備えています。

## 主な機能 (Features)

- **リアルタイム周波数解析**:
  - マイクからの音声入力を常時キャプチャし、FFT（高速フーリエ変換）を用いてリアルタイムに周波数スペクトルを解析します。
- **信号パターンの検出**:
  - 直近の周波数シーケンスを分析し、事前に定義された特定のパターンに一致するかどうかを判定します。
- **動的なライトエフェクト**:
  - 検出された信号に応じて、画面全体の色を変化させたり、点滅させたりするライトパターンを実行します。
  - 色の遷移や点滅には、`EaseOut`, `EaseIn`, `Blink` などのイージング（加減速）カーブが適用され、滑らかで見た目に美しいアニメーションを実現しています。
- **インタラクティブなUI**:
    - **周波数可視化**: 検出された各周波数の強度を棒グラフとしてリアルタイムに画面に表示します。
    - **ボトムシートによるコントロールパネル**: 画面下部をスワイプアップ、またはグラフ部分をタップすることで、設定用のコントロールパネルが表示されます。
    - **動的な感度・音量調整**: コントロールパネルのスライダーを操作することで、「グラフの表示感度」と「音声フィードバックの音量」をリアルタイムで動的に調整できます。
- **音声フィードバック**:
  - 検出した周波数（信号）を、iFFT（逆FFT）を用いて可聴域のトーンとして再合成し、スピーカーから再生します。これにより、本来聞こえない高周波数の音響信号を聴覚的に確認できます。

## 技術的な特徴 (Technical Highlights)

- **アーキテクチャ**:
  - **関心の分離 (Separation of Concerns)**: UI（`MainActivity`）、音声キャプチャ（`FrequenciesCapture`）、信号解析（`SignalAnalyzer`）、ライトパターン実行（`LightPattern`）、音声合成（`AudioSynthesizer`）の各責務が、明確に分離されたクラスで実装されています。
  - **設定の一元管理**: `Config.kt` シングルトンにより、サンプルレートやFFTサイズといった音声処理のコアな設定をアプリケーション全体で一貫して管理します。
- **UI**:
  - UIは **Jetpack Compose** を用いて、モダンで宣言的なスタイルで構築されています。
  - **状態管理 (State Management)**: UIの状態（スライダーの値など）は、単一方向データフロー（UDF）の原則に従い、`Activity`レベルで管理（State Hoisting）されています。これにより、UIの再利用性、テスト容易性、および状態の永続化への拡張性が高められています。
  - **インタラクション**: `ModalBottomSheet` を利用して、インタラクティブな設定パネルを提供しています。
- **音声処理**:
  - FFT計算には、実績のあるライブラリ `JTransforms` を利用しています。
  - パフォーマンス向上のため、FFT処理は単精度浮動小数点数 (`FloatFFT_1D`) を使用しています。
  - FFTの精度を向上させるため、入力音声データに **ハニング窓（Hanning Window）** を適用し、スペクトル漏れを抑制しています。
- **並行処理とスレッドセーフティ**:
  - 音声キャプチャ、FFT、信号解析、音声合成といった負荷の高い処理は、バックグラウンドスレッド（Kotlin Coroutines）で実行され、UIの応答性を維持しています。
  - 複数スレッドからアクセスされる共有データ（周波数シーケンスやノイズレベルのシーケンス）は、`ConcurrentLinkedQueue` を使用することで、ロックフリーで効率的なスレッドセーフティを確保しています。
- **アニメーション**:
  - 色の遷移や点滅を制御するアニメーションカーブは `Easing.kt` に集約されています。これにより、アニメーションの振る舞いを再利用可能で拡張性の高い形で管理しています。

## セットアップとビルド (Setup & Build)

### 必要なもの

- Android Studio (Iguana 以降を推奨)
- Kotlin プラグイン
- Android SDK (APIレベル 34 以上を推奨)
- マイク付きのAndroidスマートフォン実機

### ビルド手順

1. このリポジトリをクローンします。
```
git clone https://github.com/yoshida-eth0/MiracleHeartLightApp.git
```
2. Android Studioでプロジェクトを開きます。
3. Gradleの同期が完了するのを待ちます。
4. スマートフォン実機をPCに接続し、USBデバッグを有効にします。
5. Android Studioで `app` の実行構成を選択し、実行ボタン（▶️）をクリックします。
6. アプリがデバイスにインストールされ、起動します。初回起動時にマイクへのアクセス許可を求められるので、許可してください。

## ライセンス (License)

このプロジェクトは MIT License の下で公開されています。
